<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anti-Sleeping Car Project - PyScript Hub</title>
    <meta name="author" content="Sunil Mishra">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "TechArticle",
      "headline": "Anti-Sleeping Car Monitoring System",
      "author": {
        "@type": "Person",
        "name": "Sunil Mishra"
      },
      "description": "An IoT project using ESP32 and MicroPython to detect driver drowsiness and prevent accidents."
    }
    </script>

    <link rel="stylesheet" href="../css/style.css">
    <script src="../js/main.js" defer></script>

    <!-- Highlight.js -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
            <!-- Favicon -->
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
</head>

<body>

    <header>
        <div class="container">
            <nav>
                <div class="logo">
                    <a href="../" style="font-weight: 800; font-size: 1.5rem;">PyScript<span
                            style="color:var(--primary-color)">Hub</span></a>
                </div>
                <ul class="nav-links">
                    <li><a href="../">Home</a></li>
                    <li><a href="../projects/" class="active">Projects</a></li>
                    <li><a href="../pyscript-demo.html">Interactive PyScript</a></li>
                    <li><a href="../docs/embedded.html">ESP32 Guide</a></li>
                </ul>
                <button id="theme-toggle" aria-label="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
            </nav>
        </div>
    </header>

    <main class="container">
        <section class="fade-in">
            <h1>Anti-Sleeping Car Monitoring System</h1>
            <p>Preventing accidents caused by driver fatigue using IoT technology.</p>
            <div style="margin-top: 1rem;">
                <span
                    style="background: var(--accent-color); color: #000; padding: 0.3rem 0.8rem; border-radius: 4px; font-weight: bold;">IoT</span>
                <span
                    style="background: var(--secondary-color); color: #fff; padding: 0.3rem 0.8rem; border-radius: 4px; font-weight: bold;">Safety</span>
            </div>
        </section>

        <!-- Overview -->
        <section class="fade-in">
            <h2>Project Overview</h2>
            <p>
                Drowsy driving is a major cause of road accidents. This project aims to detect when a driver is falling
                asleep
                and alert them immediately to prevent collisions. By using an <strong>ESP32 microcontroller</strong> and
                sensors,
                we can monitor the driver's state (e.g., eye blink rate or head tilt) and trigger a loud alarm.
            </p>
        </section>

        <!-- Hardware -->
        <section class="fade-in">
            <h2>Hardware Requirements</h2>
            <div class="grid stagger-grid"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                <div class="card" style="padding: 1rem; border: 1px solid var(--border-color);">
                    <h3>ESP32 Board</h3>
                    <p>The brain of the system, handling sensor data and logic.</p>
                </div>
                <div class="card" style="padding: 1rem; border: 1px solid var(--border-color);">
                    <h3>IR / Eye Sensor</h3>
                    <p>Detects if eyes are closed (blink sensor module).</p>
                </div>
                <div class="card" style="padding: 1rem; border: 1px solid var(--border-color);">
                    <h3>Buzzer</h3>
                    <p>Active buzzer to sound an alarm when drowsiness is detected.</p>
                </div>
                <div class="card" style="padding: 1rem; border: 1px solid var(--border-color);">
                    <h3>MEMS / Tilt Sensor</h3>
                    <p>(Optional) Detects if the driver's head is nodding off.</p>
                </div>
            </div>
        </section>

        <!-- Software -->
        <section class="fade-in">
            <h2>Software & Tools</h2>
            <p>We use <strong>MicroPython</strong> for its ease of use and rapid prototyping capabilities.</p>
            <ul>
                <li><strong>IDE:</strong> Thonny IDE (Recommended for beginners)</li>
                <li><strong>Language:</strong> MicroPython</li>
                <li><strong>Firmware:</strong> Standard ESP32 MicroPython firmware</li>
            </ul>
        </section>

        <!-- Code Implementation -->
        <section class="fade-in">
            <h2>Code Implementation</h2>
            <p>Here is a basic example of the logic used to detect drowsiness. In this simplified version, we read a
                digital sensor (like an IR eye blink sensor) and trigger a buzzer if the eye remains closed for too
                long.</p>

            <div class="card" style="padding: 0; overflow: hidden; border: 1px solid var(--border-color);">
                <pre><code class="language-python">import network
import socket
from machine import Pin, PWM, UART, Timer
import time
import sys

# ------------------------------
# ====== PIN CONFIG ============
# ------------------------------
# Motor direction pins
LEFT_FWD  = Pin(25, Pin.OUT)
LEFT_BKD  = Pin(26, Pin.OUT)
RIGHT_FWD = Pin(27, Pin.OUT)
RIGHT_BKD = Pin(14, Pin.OUT)

# PWM enable pins for speed control
PWM_LEFT_PIN  = 12   # ENA
PWM_RIGHT_PIN = 13   # ENB

pwm_left  = PWM(Pin(PWM_LEFT_PIN), freq=1000)
pwm_right = PWM(Pin(PWM_RIGHT_PIN), freq=1000)

# default speed percent
current_speed_percent = 50

def set_pwm_from_percent(pct):
    # pct: 0..100
    if pct < 0: pct = 0
    if pct > 100: pct = 100
    duty = int((pct / 100.0) * 1023)  # ESP32 PWM duty range 0..1023
    pwm_left.duty(duty)
    pwm_right.duty(duty)

set_pwm_from_percent(current_speed_percent)

# RF receiver input pin (data line)
RF_PIN = Pin(4, Pin.IN)

# Eye sensor (eye-closed detection) input
EYE_PIN = Pin(34, Pin.IN) # 1=open/OK, 0=closed

# Buzzer and light
BUZZER = Pin(32, Pin.OUT)
HEADLIGHT = Pin(33, Pin.OUT)

# Bluetooth UART (HC-05) - using UART(2) on ESP32
# HC-05 TX -> ESP32 RX (GPIO16)
# HC-05 RX -> ESP32 TX (GPIO17)
uart = UART(2, baudrate=9600, rx=16, tx=17, timeout=10)

# ------------------------------
# ====== WIFI AP &amp; Web UI ======
# ------------------------------
ap = network.WLAN(network.AP_IF)
ap.config(essid="SmartCar_AP", password="12345678")
ap.active(True)
print("AP active, config:", ap.ifconfig())
print("Open http://192.168.4.1 to control.")

html = """&lt;!DOCTYPE html&gt;
&lt;html xmlns="http://www.w3.org/1999/html"&gt;
&lt;head&gt;
&lt;title&gt;ESP32 Smart Car&lt;/title&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;
&lt;style&gt;
body { text-align: center; font-family: Arial, sans-serif; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #fff; margin-top: 20px; }
h2 { background: #111; color: #00ffcc; padding: 10px; border-radius: 10px; display: inline-block; }
form { margin-top: 20px; }
button { width: 90px; height: 40px; margin: 6px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; color: white; background: #333; transition: background 0.3s, transform 0.1s; }
button:hover { background: #00ccff; transform: scale(1.05); }
button:active { background: #0077aa; transform: scale(0.95); }
.speed-buttons button { width: 45px; height: 35px; margin: 4px; font-size: 14px; }
.footer { margin-top: 20px; font-size: 13px; color: #aaa; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h2&gt;ðŸš— Subhadip &amp; Sunil Smart Car&lt;/h2&gt;
  &lt;form&gt;
    &lt;div&gt;
      &lt;button name="cmd" value="F"&gt;Forward&lt;/button&gt;
      &lt;button name="cmd" value="B"&gt;Backward&lt;/button&gt;&lt;br&gt;
      &lt;button name="cmd" value="L"&gt;Left&lt;/button&gt;
      &lt;button name="cmd" value="R"&gt;Right&lt;/button&gt;&lt;br&gt;
      &lt;button name="cmd" value="G"&gt;F+L&lt;/button&gt;
      &lt;button name="cmd" value="I"&gt;F+R&lt;/button&gt;
      &lt;button name="cmd" value="H"&gt;B+L&lt;/button&gt;
      &lt;button name="cmd" value="J"&gt;B+R&lt;/button&gt;&lt;br&gt;
      &lt;button name="cmd" value="S"&gt;Stop&lt;/button&gt;&lt;br&gt;
      &lt;button name="cmd" value="V"&gt;Horn&lt;/button&gt;
      &lt;button name="cmd" value="LIGHT"&gt;Light&lt;/button&gt;&lt;br&gt;
    &lt;/div&gt;
    &lt;div class="speed-buttons"&gt;
     &lt;p&gt;Speed:&lt;/p&gt;
      &lt;button name="cmd" value="0"&gt;0&lt;/button&gt;
      &lt;button name="cmd" value="1"&gt;10&lt;/button&gt;
      &lt;button name="cmd" value="2"&gt;20&lt;/button&gt;
      &lt;button name="cmd" value="3"&gt;30&lt;/button&gt;
      &lt;button name="cmd" value="4"&gt;40&lt;/button&gt;
      &lt;button name="cmd" value="5"&gt;50&lt;/button&gt;
      &lt;button name="cmd" value="6"&gt;60&lt;/button&gt;
      &lt;button name="cmd" value="7"&gt;70&lt;/button&gt;
      &lt;button name="cmd" value="8"&gt;80&lt;/button&gt;
      &lt;button name="cmd" value="9"&gt;90&lt;/button&gt;
      &lt;button name="cmd" value="q"&gt;100&lt;/button&gt;
   &lt;/div&gt;&lt;br&gt;
    &lt;button name="cmd" value="D" style="background:#ff3333;"&gt;Stop All&lt;/button&gt;
  &lt;/form&gt;
  &lt;div class="footer"&gt;Â© Subhadip &amp; Sunil | ESP32 Smart Car Project&lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
"""

# ------------------------------
# ====== TIMERS &amp; STATE ========
# ------------------------------
last_rf_time = time.time()
last_eye_time = time.time()
auto_stop_time = 3  # seconds
current_state = "STOP"

# ------------------------------
# ====== UTILITY FUNCTIONS =====
# ------------------------------
def stop_all_motors():
    LEFT_FWD.off(); LEFT_BKD.off()
    RIGHT_FWD.off(); RIGHT_BKD.off()
    global current_state
    current_state = "STOP"

def forward():
    LEFT_FWD.on(); LEFT_BKD.off()
    RIGHT_FWD.on(); RIGHT_BKD.off()
    global current_state
    current_state = "FORWARD"

def backward():
    LEFT_FWD.off(); LEFT_BKD.on()
    RIGHT_FWD.off(); RIGHT_BKD.on()
    global current_state
    current_state = "BACKWARD"

def left_turn():
    LEFT_FWD.off(); LEFT_BKD.on()
    RIGHT_FWD.on(); RIGHT_BKD.off()
    global current_state
    current_state = "LEFT"

def right_turn():
    LEFT_FWD.on(); LEFT_BKD.off()
    RIGHT_FWD.off(); RIGHT_BKD.on()
    global current_state
    current_state = "RIGHT"

def forward_left():
    LEFT_FWD.on(); LEFT_BKD.off()
    RIGHT_FWD.on(); RIGHT_BKD.off()
    global current_state
    current_state = "FORWARD_LEFT"

def forward_right():
    LEFT_FWD.on(); LEFT_BKD.off()
    RIGHT_FWD.on(); RIGHT_BKD.off()
    global current_state
    current_state = "FORWARD_RIGHT"

def back_left():
    LEFT_FWD.off(); LEFT_BKD.on()
    RIGHT_FWD.off(); RIGHT_BKD.on()
    global current_state
    current_state = "BACK_LEFT"

def back_right():
    LEFT_FWD.off(); LEFT_BKD.on()
    RIGHT_FWD.off(); RIGHT_BKD.on()
    global current_state
    current_state = "BACK_RIGHT"

def horn_beep():
    BUZZER.on()
    time.sleep(0.2)
    BUZZER.off()

def toggle_light():
    HEADLIGHT.value(not HEADLIGHT.value())

def emergency_stop_all():
    stop_all_motors()
    set_pwm_from_percent(0)
    print("EMERGENCY STOP: All stopped and PWM zeroed")

def map_speed_char_to_percent(ch):
    if ch == 'q': return 100
    if ch.isdigit(): return int(ch) * 10
    return None

def handle_command(cmd):
    global current_speed_percent
    cmd = cmd.strip()
    if not cmd: return
    if cmd == 'F': forward()
    elif cmd == 'B': backward()
    elif cmd == 'L': left_turn()
    elif cmd == 'R': right_turn()
    elif cmd == 'G': forward_left()
    elif cmd == 'I': forward_right()
    elif cmd == 'H': back_left()
    elif cmd == 'J': back_right()
    elif cmd == 'S': stop_all_motors()
    elif cmd == 'V': horn_beep()
    elif cmd == 'v': BUZZER.off()
    elif cmd == 'LIGHT': toggle_light()
    elif cmd == 'D': emergency_stop_all()
    else:
        pct = map_speed_char_to_percent(cmd)
        if pct is not None:
            current_speed_percent = pct
            set_pwm_from_percent(current_speed_percent)
            print("Speed set to", current_speed_percent, "%")
        else:
            print("Unknown command:", cmd)
    print("State:", current_state, "Speed:", current_speed_percent)

# ------------------------------
# ====== SAFETY CHECK TIMER ====
# ------------------------------
def safety_timer_callback(t):
    global last_rf_time, last_eye_time
    now = time.time()
    try:
        if RF_PIN.value() == 1: last_rf_time = now
    except: pass
    
    try:
        if EYE_PIN.value() == 1: last_eye_time = now
    except: pass

    if now - last_rf_time &gt; auto_stop_time:
        stop_all_motors()
        BUZZER.on(); print("RF signal lost"); time.sleep(0.2); BUZZER.off()
        last_rf_time = now

    if now - last_eye_time &gt; auto_stop_time:
        stop_all_motors()
        BUZZER.on(); print("Eye sensor closed"); time.sleep(0.2); BUZZER.off()
        last_eye_time = now

safety_timer = Timer(-1)
safety_timer.init(period=500, mode=Timer.PERIODIC, callback=safety_timer_callback)

# ------------------------------
# ====== WEB SERVER &amp; MAIN LOOP
# ------------------------------
def start_web_server_nonblocking():
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    s.bind(('0.0.0.0', 80))
    s.listen(1)
    s.settimeout(0.1) # Non-blocking timeout
    print("Non-blocking web server ready")
    return s

web_sock = start_web_server_nonblocking()

print("Main loop starting...")
try:
    while True:
        # 1. Bluetooth Check
        if uart.any():
            try:
                data = uart.read(1)
                if data:
                    ch = data.decode('utf-8').strip()
                    if ch: handle_command(ch)
            except Exception as e:
                print("UART error:", e)

        # 2. Web Server Check
        try:
            conn, addr = web_sock.accept()
            request = conn.recv(1024)
            if request:
                req_str = str(request)
                if "cmd=" in req_str:
                    try:
                        cmd = req_str.split("cmd=")[1].split(" ")[0]
                        cmd = cmd.split("+")[0] # clean URL encoding
                        handle_command(cmd)
                    except: pass
            conn.send("HTTP/1.1 200 OK\nContent-Type: text/html\nConnection: close\n\n")
            conn.sendall(html)
            conn.close()
        except OSError:
            pass # No connection, continue loop

        # 3. Sensor Instant Check
        if RF_PIN.value() == 1: last_rf_time = time.time()
        if EYE_PIN.value() == 1: last_eye_time = time.time()
        
        time.sleep(0.01)

except KeyboardInterrupt:
    stop_all_motors()
    pwm_left.deinit()
    pwm_right.deinit()
    web_sock.close()
    sys.exit()
</code></pre>
            </div>
        </section>

        <section class="fade-in">
            <h2>Future Improvements</h2>
            <p>This project can be enhanced by adding:</p>
            <ul style="margin-left: 1.5rem;">
                <li><strong>Camera Module (ESP32-CAM):</strong> For visual face tracking and more accurate eye detection
                    using OpenCV (on a host) or basic image processing.</li>
                <li><strong>GPS Module:</strong> To send the vehicle location to emergency contacts in case of no
                    response.</li>
                <li><strong>IoT Dashboard:</strong> Send data to the cloud to monitor driving habits over time.</li>
            </ul>
        </section>

        <div style="margin-top: 3rem; text-align: center;">
            <a href="" class="btn" style="background: var(--secondary-color);">Back to Projects</a>
        </div>

    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 PyScript Hub.</p>
        </div>
    </footer>
</body>

</html>